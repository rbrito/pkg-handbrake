From: =?UTF-8?q?Rog=C3=A9rio=20Brito?= <rbrito@ime.usp.br>
Date: Thu, 7 Jun 2012 07:09:37 -0300
Subject: First try at removing some of mp4v2.

Forwarded: partially (only first hunk)
Signed-off-by: Rog√©rio Brito <rbrito@ime.usp.br>

--- a/libhb/muxmp4.c
+++ b/libhb/muxmp4.c
@@ -1,3 +1,4 @@
+#if 0
 /* $Id: muxmp4.c,v 1.24 2005/11/04 13:09:41 titer Exp $
 
    This file is part of the HandBrake source code.
@@ -1356,3 +1357,4 @@
     return m;
 }
 
+#endif /* 0*/
--- a/gtk/src/Makefile.am
+++ b/gtk/src/Makefile.am
@@ -4,13 +4,13 @@
 HB_LIBS= \
 	-lhb -la52 -lmkv -lavformat -lavcodec -lavutil -ldca -ldvdnav -ldvdread \
 	-lmp3lame -lmpeg2 -lvorbis -lvorbisenc -logg -lsamplerate \
-	-lx264 -lmp4v2 -lswscale -ltheora -lz \
+	-lx264 -lswscale -ltheora -lz \
 	-lbz2 -liberty -lpthreadGC2 -lbluray -lass -lfontconfig -lfreetype
 else
 HB_LIBS= \
 	-lhb -la52 -lmkv -lavformat -lavcodec -lavutil -ldca -ldvdnav -ldvdread \
 	-lmp3lame -lmpeg2 -lvorbis -lvorbisenc -logg -lsamplerate \
-	-lx264 -lmp4v2 -lswscale -ltheoraenc -ltheoradec -lz -lxml2 \
+	-lx264 -lswscale -ltheoraenc -ltheoradec -lz -lxml2 \
 	-lbz2 -lpthread -lbluray -lass -lfontconfig -lfreetype
 endif
 
--- a/libhb/muxcommon.c
+++ b/libhb/muxcommon.c
@@ -459,8 +459,9 @@
         switch( job->mux )
         {
         case HB_MUX_MP4:
-            mux->m = hb_mux_mp4_init( job );
-            break;
+            hb_error( "MP4 muxer disabled, exiting" );
+            *job->die = 1;
+            return NULL;
         case HB_MUX_MKV:
             mux->m = hb_mux_mkv_init( job );
             break;
--- a/test/module.defs
+++ b/test/module.defs
@@ -10,7 +10,7 @@
 TEST.exe = $(BUILD/)$(call TARGET.exe,$(HB.name)CLI)
 
 TEST.libs = $(LIBHB.a)
-TEST.libs += -lass -lmp3lame -lsamplerate -lvorbisenc -ltheoraenc -ltheoradec -lvorbis -lx264 -lmkv -lz -lbz2 -lpthread -ldl -lmp4v2 -lxml2 -ldca -la52 -lbluray -lavcodec -lavformat -lavutil -lswscale -lmpeg2 -ldvdnav -ldvdread
+TEST.libs += -lass -lmp3lame -lsamplerate -lvorbisenc -ltheoraenc -ltheoradec -lvorbis -lx264 -lmkv -lz -lbz2 -lpthread -ldl -lxml2 -ldca -la52 -lbluray -lavcodec -lavformat -lavutil -lswscale -lmpeg2 -ldvdnav -ldvdread
 
 TEST.install.exe = $(DESTDIR)$(PREFIX/)bin/$(notdir $(TEST.exe))
 
--- a/libhb/decmetadata.c
+++ b/libhb/decmetadata.c
@@ -4,10 +4,11 @@
    Homepage: <http://handbrake.fr/>.
    It may be used under the terms of the GNU General Public License. */
 
-#include <mp4v2/mp4v2.h>
-
 #include "common.h"
 
+#if 0
+#include <mp4v2/mp4v2.h>
+
 static void decmp4metadata( hb_title_t *title )
 {
     MP4FileHandle input_file;
@@ -95,6 +96,7 @@
         MP4Close(input_file, 0);
     }
 }
+#endif /* 0 */
 
 /*
  * decmetadata()
@@ -121,14 +123,6 @@
         return;
     }
 
-    /*
-     * Hacky way of figuring out if this is an MP4, in which case read the data using libmp4v2
-     */
-    if( title->container_name && strcmp(title->container_name, "mov,mp4,m4a,3gp,3g2,mj2") == 0 ) 
-    {
-        decmp4metadata( title );
-    } else {
         free( title->metadata );
         title->metadata = NULL;
-    }
 }
--- a/libhb/scan.c
+++ b/libhb/scan.c
@@ -301,7 +301,7 @@
         job->list_audio = hb_list_init();
         job->list_subtitle = hb_list_init();
 
-        job->mux = HB_MUX_MP4;
+        job->mux = HB_MUX_MKV;
     }
 
 finish:
--- a/gtk/src/hb-backend.c
+++ b/gtk/src/hb-backend.c
@@ -176,7 +176,6 @@
 static options_map_t d_container_opts[] =
 {
 	{"MKV", "mkv", HB_MUX_MKV, "mkv"},
-	{"MP4", "mp4", HB_MUX_MP4, "mp4"},
 };
 combo_opts_t container_opts =
 {
--- a/gtk/src/presets.c
+++ b/gtk/src/presets.c
@@ -1366,7 +1366,7 @@
 	str = ghb_settings_get_string(ud->settings, "destination_dir");
 	ghb_ui_update(ud, "dest_dir", ghb_string_value(str));
 
-	gchar *file = g_strdup_printf ("new_video.mp4");
+	gchar *file = g_strdup_printf ("new_video.mkv");
 	ghb_ui_update(ud, "dest_file", ghb_string_value(file));
 	g_free(str);
 	g_free(file);
--- a/gtk/src/internal_defaults.xml
+++ b/gtk/src/internal_defaults.xml
@@ -19,7 +19,7 @@
 		<key>dest_dir</key>
 		<string></string>
 		<key>dest_file</key>
-		<string>new_video.mp4</string>
+		<string>new_video.mkv</string>
 		<key>end_point</key>
 		<integer>100</integer>
 		<key>folder</key>
@@ -238,7 +238,7 @@
 		<key>ChapterMarkers</key>
 		<true />
 		<key>FileFormat</key>
-		<string>mp4</string>
+		<string>mkv</string>
 		<key>Folder</key>
 		<false />
 		<key>PictureLooseCrop</key>
